<% count = 0 %>
<style>
.createProject{
color:#fff !important;
margin-left: -20px !important;
}
.createProject:hover{
color:#fff !important;
margin-left: -20px !important;
}

#moreTimesheetButton{
  margin:3% 0 3% 60%;
}

#moreButton{
    float:right;
    margin:0 23px 0 0;
}

.pagination {
    background: #f2f2f2;
    padding: 20px;
    margin-bottom: 20px;
}

.page {
    display: inline-block;
    padding: 0px 9px;
    margin-right: 4px;
    border-radius: 3px;
    border: solid 1px #c0c0c0;
    background: #e9e9e9;
    box-shadow: inset 0px 1px 0px rgba(255,255,255, .8), 0px 1px 3px rgba(0,0,0, .1);
    font-size: .875em;
    font-weight: bold;
    text-decoration: none;
    color: #717171;
    text-shadow: 0px 1px 0px rgba(255,255,255, 1);
}

.page:hover, .page.gradient:hover {
    background: #fefefe;
    background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#FEFEFE), to(#f0f0f0));
    background: -moz-linear-gradient(0% 0% 270deg,#FEFEFE, #f0f0f0);
}

.page.active {
    border: none;
    background: #4ca15b;
    box-shadow: inset 0px 0px 8px rgba(0,0,0, .5), 0px 1px 0px rgba(255,255,255, .8);
    color: #f0f0f0;
    text-shadow: 0px 0px 3px rgba(0,0,0, .5);
}

.page.gradient {
    background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#f8f8f8), to(#e9e9e9));
    background: -moz-linear-gradient(0% 0% 270deg,#f8f8f8, #e9e9e9);
}

.pagination.dark {
    background: #ffffff;
    color: #feffff;
}

.page.dark {
    border: solid 1px #32373b;
    background: #3e4347;
    box-shadow: inset 0px 1px 1px rgba(255,255,255, .1), 0px 1px 3px rgba(0,0,0, .1);
    color: #feffff;
    text-shadow: 0px 1px 0px rgba(0,0,0, .5);
}

.page.dark:hover, .page.dark.gradient:hover {
    background: #3d4f5d;
    background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#547085), to(#3d4f5d));
    background: -moz-linear-gradient(0% 0% 270deg,#547085, #3d4f5d);
}

.page.dark.active {
    border: none;
    background: #2f3237;
    box-shadow: inset 0px 0px 50px rgba(0,0,0, .5), 0px 1px 0px rgba(255,255,255, .1);
}

.page.dark.gradient {
    background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#565b5f), to(#3e4347));
    background: -moz-linear-gradient(0% 0% 270deg,#565b5f, #3e4347);
}
</style>

<% if params.has_key?(:group_id) %>
<input type="hidden" value="<%= params[:group_id] %>" id="params_groupid" style="display:none;" />
<% else %>
<input type="hidden" value="0" id="params_groupid" style="display:none;" />
<% end %>

<% if params.has_key?(:engagement_id) %>
<input type="hidden" value="<%= params[:engagement_id] %>" id="params_engagementid" style="display:none;" />
<% else %>
<input type="hidden" value="0" id="params_engagementid" style="display:none;" />
<% end %>

<input type="hidden" value="<%= @projects_count %>" id="projectsCount" style="display:none;" />
<% if @user_in_client==0 %>

<% content_for :sidebar do %>

    <% if User.current.admin? %>
    <% engagement_id = params[:engagement_id].present? ? params[:engagement_id] : "" %>
    <% group_id = params[:group_id].present? ? params[:group_id] : "" %>
       <div id="filterGroup">
        <%=select_tag "group", options_from_collection_for_select(@groups.sort!, "id", "lastname"), prompt: "Select Group", :onchange => "showGroupProjects($(this).val(),'#{engagement_id}');"%>
      </div>
      <div id="filterGroup">
        <%=select_tag "engagement", options_for_select(["Fixed Bid", "Retainer", "T&M"]), prompt: "Select Engagement", :onchange => "showEngagementProjects($(this).val(),'#{group_id}');"%>
      </div>
    <% end %>

    <% if User.current.manager? || User.current.admin? %>
    <aside class="contentRightColumn createProjectHeader">
      <h3><span></span><%= link_to("Create Account", {:controller => 'projects', :action => 'new'}, :class => 'createProject') + ''  %></h3>
    </aside>
    <% end %>
    
  <% if !User.current.admin? %>

  <aside class="contentRightColumn">

    <h3>General Activity <span class="logHistorySpan"> <%= link_to( "", project_time_entries_path(@project_general)) %></span></h3>
    <div class="rightSideBarInnerContent spentTimeRightSideDiv contentRightColumnContent">

      <%= labelled_form_for @time_entry, :url => time_entries_path, :remote => true do |f| %>
        <%= hidden_field_tag 'project_id', @project_general.id if @project_general %>
      
        <div class="box tabular"> 
          <%= f.hidden_field :project_id, :value => @project_general.id %>
          <p><%= f.text_field :spent_on, :readonly => true, :size => 10, :required => true %><%= calendar_for('time_entry_spent_on') %></p>     
          <p class="hourAndMinutes">
            <%= render :partial => "timelog/hours_mins", :locals => {:f => f, :type=>"timelog"} %> 
          </p>
          <p><%= f.text_field :comments, :required => true, :size => 100, :maxlength => 255 %></p>
          <p><%= f.select :activity_id, activity_collection_for_select_options(@time_entry), :required => true %></p>
          <%= call_hook(:view_timelog_edit_form_bottom, { :time_entry => @time_entry, :form => f }) %>
          <%= f.hidden_field :form_type, :value => "partial_form" %>
          <p><%= submit_tag l(:button_create),:class=>'greenBtn partial_form' %></p>
        </div>
      <% end %>
    </div>
    <p class="sprintTotallogTime">     
      <span class="icon icon-time span_general_activity_time">
        Total Time Spent - <strong>         
         <% @total_hours_gn = TimeEntry.sum_hours(@tmhours.collect(&:hours))%>
        <%=@total_hours_gn.nil? ? '0.00' : @total_hours_gn%> </strong>
     </span>
    </p>
</aside>

<% end %>

    
<aside class="contentRightColumn">

   <!-- <h3>TimeSheet</h3>
   <div id="container">
      <div class="pagination dark timepage">
        <h4>Search other pages for more results</h4>
        <% (1..@total_pages).each do |i| %>
            <a href="javascript:void(0)" class="paginate_click page" id="<%= i %>-page"><%= i %></a>
        <% end %>
      </div>
    </div> -->

   
    <div class="contentRightColumnContent">
      <br>
      <table width="100%" cellpadding="10" cellspacing="0" class="formTable rightSideProjectTable timesheet_row">
        <%= render :partial => "timesheet" %>
     </table>
    </div>
   
    <% if @projects_count > 2 %>
      <div id="moreTimesheetButton"><a href="javascript:void(0)" class="moreTimesheetAccounts greenBtn">Load More...</a></div>
    <% end %>

   <p class="sprintTotallogTime">         
      <span class="icon icon-time">
        Total Time Spent - <strong>
        <%= TimeEntry.sum_hours(@time_entries.collect(&:billable)) %></strong>
     </span>
  </p>

</aside>

<div class="clear"></div>      
<% end %>

<% end %>

<!-- Listing the account name only for Admin dashboard.     -->

<% if User.current.manager? || User.current.admin? %>
<%= render :partial => 'favorites' %>
<% end %>

<div id="accounts_row" class="accounts_row">
  <%= render :partial => "projects" %>
</div>

<% if @projects_count > 2 %>
  <div id="moreButton"><a href="javascript:void(0)" class="moreAccounts greenBtn">More Projects...</a></div>
<% end %>

    <% if @projects.empty? %>
      <p>No projects available</p>
    <% end%>
  
    <div class="clear"></div>
    <%=hidden_field_tag 'project_count', "#{@projects.count}"%>
<script type="text/javascript">

    $(".fav_project").hover(function(){
      $(this).children('img').attr("src","<%= Setting.app %>/images/favbright.png");
    })

    $('.fav_project').live("mouseleave", function () {
      $(this).children('img').attr("src","<%= Setting.app %>/images/favdull.png");
    });

    $(".unfav_project").hover(function(){
      $(this).children('img').attr("src","<%= Setting.app %>/images/favdull.png");
    })

    $('.unfav_project').live("mouseleave", function () {
      $(this).children('img').attr("src","<%= Setting.app %>/images/favbright.png");
    });

  
 function showGroupProjects(value,type){
  if(value!="") {
    if(type != "") {
      window.location.href="<%= home_session_path%>" + "?group_id="+value+"&engagement_id="+type;
    } else {
      window.location.href="<%= home_session_path%>" + "?group_id="+value; 
    }
    
  } else {
    if(type != "") {
      window.location.href="<%= home_session_path%>" + "?engagement_id="+type;
    } else {
      window.location.href="<%= home_session_path%>";
    }
  }
 }

 function showEngagementProjects(value,group_id){
  if(value!="")
  {
    if(value=="Retainer")
    {
      if(group_id != "") {
        window.location.href="<%= home_session_path%>" + "?engagement_id=1&group_id="+group_id;
      } else {
        window.location.href="<%= home_session_path%>" + "?engagement_id=1";
      }
      
    }
    else if(value=="Fixed Bid")
    {
      if(group_id != "") {
        window.location.href="<%= home_session_path%>" + "?engagement_id=2&group_id="+group_id;
      } else {
        window.location.href="<%= home_session_path%>" + "?engagement_id=2";
      }
    }
    else
    {
      if(group_id != "") {
        window.location.href="<%= home_session_path%>" + "?engagement_id=3&group_id="+group_id;
      } else {
        window.location.href="<%= home_session_path%>" + "?engagement_id=3";
      }
      
    }
  }
  else
  {
    if(group_id != "") {
        window.location.href="<%= home_session_path%>" + "?group_id="+group_id;
    } else {
        window.location.href="<%= home_session_path%>";
    }
  }
 }

  function fnClearJquerySelectBox(control,value)
  {    
    $('#'+control).selectbox("detach");    
    $('#'+control).val(value);
    $('#'+control).selectbox("attach");
  }
  jQuery(document).ready(function($) {
    <%if params.has_key?('group_id')%>      
      $('#group').val(<%=params['group_id']%>);
    <%end%>

    <%if params.has_key?('engagement_id')%>
      var eng_id = <%=params['engagement_id']%>;
      if(eng_id==1)
      {
        var eng_text = "Retainer";
      }
      else if(eng_id==2)
      {
        var eng_text = "Fixed Bid";
      }
      else
      {
        var eng_text = "T&M";
      }
      $('#engagement').val(eng_text);
    <%end%>

    $("#main-menu").hide();
    $('.partial_form').live( "click", function() {    
      //form.preventDefault();    
      if($('#time_entry_comments').val()=="")
      {
        showFlashError("Comment, Time and Activity are mandatory for Time Logging!");
      }
      else
      {        
        $('.greenBtn').attr('disabled', true);
        $('.greenBtn').addClass('grayBtn');
        $('#flash_error').hide();
        $('#flash_notice').hide();
        var arr = $(".new_time_entry").serializeArray();
        var hours; var mins;
        $.each(arr, function(i, fd) {
          if(fd.name == "time_entry[hours]")  hours = parseInt(fd.value);
          if(fd.name == "[mins]") mins = parseInt(fd.value);
        });
        time = $(".span_general_activity_time strong").text().trim().split(".");

        $.ajax({
          type: $(".new_time_entry").attr('method'),
          url: '<%= time_entries_path%>',
          data: $(".new_time_entry").serialize(),
          success: function(response){
            if(response.length<55)
            {
              showFlashError("Comments, Time and Activity are mandatory for Time Logging!");
            }
            else
            {
              window.location.href="<%= home_session_path%>";
              // showFlashNotice('Successfully added!');              
              // hours +=parseInt(time[0]);
              // realmin = ((parseInt(time[1])+mins)%60);
              // hours += Math.floor((parseInt(time[1])+mins) / 60);
              // if(realmin<=5) realmin = "0"+realmin.toString();

              // $(".span_general_activity_time strong").text(hours.toString()+"."+realmin.toString() + " ");
              // $('#time_entry_comments').val('');
              // fnClearJquerySelectBox("time_entry_hours","0");
              // fnClearJquerySelectBox("mins","0");
              // fnClearJquerySelectBox("time_entry_activity_id","");
            }
           $('html,body').animate({ scrollTop: 0 }, 'slow', function () { });
           $('.greenBtn').removeAttr('disabled');
           $('.greenBtn').removeClass('grayBtn');
          }
        });
        return false;
      }
    });


    // if ($("body").height() > $(window).height()) {
    //     alert("Vertical Scrollbar! D:");
    // }
    // else
    // {
    //   var accounts_count = $('#projectsCount').val();
    //   if(accounts_count >2)
    //   {
    //     $('#moreButton').show();
    //   }
    // }

    var page_time = 1;
    $(".moreTimesheetAccounts").click(function(){

      var comments_count = $('#projectsCount').val();   
      if ($('.contentRightColumnContent table tr.rightSideProjectTitle').length < comments_count){

      var prms_grpid = $("#params_groupid").val();
      var prms_engagementid = $("#params_engagementid").val();

         if(prms_grpid!=0 && prms_engagementid!=0) {
            $.ajax({
                  url: "get_accounts_timesheet",
                  data: { pageno: page_time, groupid: prms_grpid, engagement_id: prms_engagementid },
                  type: 'get',
                  dataType: 'html',
                success: function(data)
                {
                   $('.timesheet_row').append(data);
                }
            });
            page_time+=1;

         } else if(prms_grpid!=0) {
                    $.ajax({
                          url: "get_accounts_timesheet",
                          data: { pageno: page_time, groupid: prms_grpid },
                          type: 'get',
                          dataType: 'html',
                        success: function(data)
                        {
                           $('.timesheet_row').append(data);
                        }
                    });
                    page_time+=1;
         } else if(prms_engagementid!=0){
                    $.ajax({
                          url: "get_accounts_timesheet",
                          data: { pageno: page_time, engagement_id: prms_engagementid },
                          type: 'get',
                          dataType: 'html',
                        success: function(data)
                        {
                           $('.timesheet_row').append(data);
                        }
                    });
                    page+=1;
            } else {
                    $.ajax({
                          url: "get_accounts_timesheet",
                          data: { pageno: page_time },
                          type: 'get',
                          dataType: 'html',
                        success: function(data)
                        {
                           $('.timesheet_row').append(data);
                        }
                    });
                    page_time+=1;
            }

        } else {
            $('#moreTimesheetButton').hide();
        }

    });

    var page = 1;
    $(".moreAccounts").click(function(){
      var comments_count = $('#projectsCount').val();
         //if($(window).scrollTop() == $(document).height()-$(window).height()){
          if ($('#accounts_row').children("#project_updates").size() < comments_count){
            var prms_grpid = $("#params_groupid").val();
            var prms_engagementid = $("#params_engagementid").val();
              if(prms_grpid!=0 && prms_engagementid!=0) {
                $.ajax({
                        url: "get_accounts",
                        data: {page: (page+1), groupid: prms_grpid,engagement_id: prms_engagementid },
                        type: 'get',
                        dataType: 'html',
                      success: function(data)
                      {
                         $('#accounts_row').append(data);
                      }
                  });
                page+=1;
              } else if(prms_grpid!=0) {
                $.ajax({
                        url: "get_accounts",
                        data: {page: (page+1), groupid: prms_grpid },
                        type: 'get',
                        dataType: 'html',
                      success: function(data)
                      {
                         $('#accounts_row').append(data);
                      }
                  });
                page+=1;
              } else if(prms_engagementid!=0) {
                $.ajax({
                      url: "get_accounts",
                      data: {page: (page+1), engagement_id: prms_engagementid },
                      type: 'get',
                      dataType: 'html',
                    success: function(data)
                    {
                       $('#accounts_row').append(data);
                    }
                });
                page+=1;
              }
              else
              {
                $.ajax({
                      url: "get_accounts",
                      data: {page: (page+1)},
                      type: 'get',
                      dataType: 'html',
                    success: function(data)
                    {
                       $('#accounts_row').append(data);
                    }
                });
                page+=1;
              }
          }
          else{
            $('#moreButton').hide();
          }
       // }
    });
    


    // Load on scroll in dashboard
    $(window).scroll(function(){
        var comments_count = $('#projectsCount').val();
         //if($(window).scrollTop() == $(document).height()-$(window).height()){
          if ($('#accounts_row').children("#project_updates").size() < comments_count){
            var prms_grpid = $("#params_groupid").val();
            var prms_engagementid = $("#params_engagementid").val();
              if(prms_grpid!=0 && prms_engagementid!=0) {
                $.ajax({
                        url: "get_accounts",
                        data: {page: (page+1), groupid: prms_grpid,engagement_id: prms_engagementid },
                        type: 'get',
                        dataType: 'html',
                      success: function(data)
                      {
                         $('#accounts_row').append(data);
                      }
                  });
                page+=1;
              } else if(prms_grpid!=0) {
                  $.ajax({
                          url: "get_accounts",
                          data: {page: (page+1), groupid: prms_grpid },
                          type: 'get',
                          dataType: 'html',
                        success: function(data)
                        {
                           $('#accounts_row').append(data);
                        }
                    });
                    page+=1;
              } else if(prms_engagementid!=0) {
                $.ajax({
                      url: "get_accounts",
                      data: {page: (page+1), engagement_id: prms_engagementid },
                      type: 'get',
                      dataType: 'html',
                    success: function(data)
                    {
                       $('#accounts_row').append(data);
                    }
                });
                page+=1;
              } else {
                  $.ajax({
                        url: "get_accounts",
                        data: {page: (page+1)},
                        type: 'get',
                        dataType: 'html',
                      success: function(data)
                      {
                         $('#accounts_row').append(data);
                      }
                  });
                  page+=1;
              }
          }
          else{
            $('#moreButton').hide();
          }
       // }
    });

    $('.pagination a:first').addClass('active');

    if($('.paginate_click').length ==1)
    {
      $('.paginate_click').removeClass('paginate_click');
    }


    $(".paginate_click").click(function(){

      var clicked_id = $(this).attr("id").split("-");
      var page_num = parseInt(clicked_id[0]);

      var prms_grpid = $("#params_groupid").val();
      var prms_engagementid = $("#params_engagementid").val();

      $('.paginate_click').removeClass('active');
      $(this).addClass('active');

      if(prms_grpid!=0)
              {
                $.ajax({
                      url: "get_accounts_timesheet",
                      data: { pageno: page_num-1, groupid: prms_grpid },
                      type: 'get',
                      dataType: 'html',
                    success: function(data)
                    {
                       $('#timesheet_row').html(data);
                    }
            });
              }
              else if(prms_engagementid!=0)
              {
                $.ajax({
                      url: "get_accounts_timesheet",
                      data: { pageno: page_num-1, engagement_id: prms_engagementid },
                      type: 'get',
                      dataType: 'html',
                    success: function(data)
                    {
                       $('#timesheet_row').html(data);
                    }
                });
                page+=1;
              }
              else{
                $.ajax({
                      url: "get_accounts_timesheet",
                      data: { pageno: page_num-1 },
                      type: 'get',
                      dataType: 'html',
                    success: function(data)
                    {
                       $('#timesheet_row').html(data);
                    }
            });
              }

        }); 

    
    });

</script>

<% html_title(l(:label_dashboard)) -%>