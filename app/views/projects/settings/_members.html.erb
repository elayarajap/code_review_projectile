<%= error_messages_for 'member' %>
<% roles = Role.find_all_givable
   members = @project.member_principals.includes(:roles, :principal).all.sort %>

<div class="splitcontentleft">
  <% if members.any? %>
  <table class="tblProjectMembers list members formTable">
    <thead>
      <tr>
        <th><%= l(:label_user) %> / <%= l(:label_group) %></th>
        <th><%= l(:label_role_plural) %></th>
        <th style="width:15%"></th>
        <%= call_hook(:view_projects_settings_members_table_header, :project => @project) %>
      </tr>
    </thead>
    <tbody>
    <% members.each do |member| %>
    <% next if member.new_record? %>
    <tr id="member-<%= member.id %>" class="<%= cycle 'odd', 'even' %> member">
      <td class="<%= member.principal.class.name.downcase %> textAlignLeft"><%= link_to_user member.principal %></td>
      <td class="roles textAlignLeft">
        <span id="member-<%= member.id %>-roles"><%=h member.roles.sort.collect(&:to_s).join(', ') %></span>
          <%= form_for(member, {:as => :membership, :remote => true, :url => membership_path(member),
                                              :method => :put,
                                              :html => { :id => "member-#{member.id}-roles-form", :class => 'hol' }}
                 ) do |f| %>
            <p><% roles.each do |role| %>
            <label><%= check_box_tag 'membership[role_ids][]', role.id, member.roles.include?(role),
                                                           :disabled => member.member_roles.detect {|mr| mr.role_id == role.id && !mr.inherited_from.nil?} %> <%=h role %></label><br />
            <% end %></p>
            <%= hidden_field_tag 'membership[role_ids][]', '' %>
            <p><%= submit_tag l(:button_change), :class => "greenBtn" %>
            <%= link_to_function l(:button_cancel),
                                 "$('#member-#{member.id}-roles').show(); $('#member-#{member.id}-roles-form').hide(); return false;",:class => "blueBtn"
                 %></p>
          <% end %>
      </td>
      <td class="buttons">
          <%= link_to_function l(:button_edit),
                               "$('#member-#{member.id}-roles').hide(); $('#member-#{member.id}-roles-form').show(); return false;",
                               :class => 'icon icon-edit' %>
          <%= delete_link membership_path(member),
                          :remote => true,
                          :data => (!User.current.admin? && member.include?(User.current) ? {:confirm => l(:text_own_membership_delete_confirmation)} : {}) if member.deletable? %>
      </td>
      <%= call_hook(:view_projects_settings_members_table_row, { :project => @project, :member => member}) %>
    </tr>
  <% end; reset_cycle %>
    <tr id="member-add-client" class="member" style="display:none;">
      <td class="textAlignLeft" colspan="3">
        <input type="text" name="first_name" id="first-name" placeholder="First name" style="width:29%;"/>&nbsp;&nbsp;
        <input type="text" name="last_name" id="last-name" placeholder="Last name" style="width:29%;"/>&nbsp;&nbsp;
        <input type="text" name="email" id="client-email" placeholder="Email id" style="width:29%;"/>
      </td>
    </tr>
    <tr id="save-cancel" class="member" style="display:none;">    
      <td class="buttons" style="color:white" colspan="3">          
        <%= link_to "Save","#", :class=> "greenBtn", :style=> "color:white;", :onclick=>"add_client_function('#{settings_project_path(@project.id)}',$('#first-name').val(),$('#last-name').val(),$('#client-email').val()); return false;"%>
        <%= link_to "Cancel","#",:class=> "blueBtn", :style=> "color:white;",:onclick=>"$('#save-cancel').hide();$('#member-add-client').hide(); $('.btnAddClient').show(); return false;"%>
      </td>
    </tr>
    </tbody>
  </table>
<% else %>
  <p class="nodata"><%= l(:label_no_data) %></p>
<% end %>
<%= link_to "Add Clients","#", :class=> "greenBtn btnAddClient", :style=> "color:white; float:right;margin:5px;", :onclick=>"$('.member').show();$('.btnAddClient').hide(); return false;"%>
</div>

<div class="splitcontentright">
<% if roles.any? %>
  <%= form_for(@member, {:as => :membership, :url => project_memberships_path(@project), :remote => true, :method => :post}) do |f| %>
    <div><h3 class="subTitleHeader"><%=l(:label_member_new)%></h3>

    <p class="fullWidthFormLabel"><%= label_tag "principal_search", l(:label_principal_search) %><%= text_field_tag 'principal_search', nil %></p>
    <%= javascript_tag "observeSearchfield('principal_search', null, '#{ escape_javascript autocomplete_project_memberships_path(@project, :format => 'js') }')" %>

    <div id="principals_for_new_member">
      <%= render_principals_for_new_members(@project) %>
    </div>

    <p><%= l(:label_role_plural) %>:
    <% roles.each do |role| %>
      <label><%= check_box_tag 'membership[role_ids][]', role.id %> <%=h role %></label>
     <% end %></p>

    <p><%= submit_tag l(:button_add), :id => 'member-add-submit',:class=>'greenBtn' %></p>
    </div>
  <% end %>
<% end %>
</div>
<script>
$(document).ready(function(){
  $(".pagination").children('a:last').trigger("click");
<%if params[:tab].present?%>
  $('#tab-members').click();
<%end%>
});
</script>